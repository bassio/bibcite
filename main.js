/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => BibcitePlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian2 = require("obsidian");

// CitationSuggest.ts
var import_obsidian = require("obsidian");
var http = require("http");
function makeHttpRequest(options, data) {
  return new Promise((resolve, reject) => {
    const req = http.request(options, (res) => {
      let responseData = "";
      res.on("data", (chunk) => {
        responseData += chunk;
      });
      res.on("end", () => {
        resolve(responseData);
      });
    });
    req.on("error", (error) => {
      reject(error);
    });
    if (data) {
      req.write(data);
    }
    req.end();
  });
}
async function locateCollection(collectionPath) {
  const jsonRpcData = {
    jsonrpc: "2.0",
    method: "user.groups",
    params: [true]
  };
  const options = {
    hostname: "localhost",
    port: 23119,
    path: "/better-bibtex/json-rpc",
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Content-Length": JSON.stringify(jsonRpcData).length
    }
  };
  const responseStr = await makeHttpRequest(options, JSON.stringify(jsonRpcData));
  const responseJson = JSON.parse(responseStr);
  const result = responseJson.result;
  const plist = collectionPath.split("/");
  const lib = plist[0];
  const after = plist.slice(1);
  const libNames = result.map((l) => l.name);
  const libIds = result.map((l) => l.id);
  const matchedLib = result[libNames.indexOf(lib)];
  const matchedLibId = libIds[libNames.indexOf(lib)];
  const allCollections = matchedLib.collections;
  const allCollectionsDict = {};
  allCollections.forEach((c) => {
    allCollectionsDict[c.key] = { ...c, children: [] };
  });
  const topCollections = allCollections.filter((c) => !c.parentCollection);
  const topCollectionsDict = {};
  topCollections.forEach((c) => {
    topCollectionsDict[c.key] = { ...c, children: [] };
  });
  const nonTopCollections = matchedLib.collections.filter((c) => c.parentCollection !== false);
  for (const coll of nonTopCollections) {
    if (coll.parentCollection in topCollectionsDict) {
      topCollectionsDict[coll.parentCollection].children.push(coll);
    }
  }
  const matchedTopCollection = topCollections.find((c) => c.name === after[0]);
  const matchedTopCollectionKey = matchedTopCollection.key;
  let children = Object.values(allCollectionsDict).filter((c) => c.parentCollection === matchedTopCollectionKey);
  let matchedChildCollectionKey = null;
  for (const cname of after.slice(1)) {
    if (matchedChildCollectionKey) {
      children = Object.values(allCollectionsDict).filter((c) => c.parentCollection === matchedChildCollectionKey);
    }
    for (const child of children) {
      if (cname === child.name) {
        matchedChildCollectionKey = child.key;
        break;
      }
    }
  }
  return { libraryId: matchedLibId, collectionId: matchedChildCollectionKey };
}
async function exportCollection(collectionId, libraryId, bibFormat = "betterbibtex") {
  const url_path = `/better-bibtex/collection?/${libraryId}/${collectionId}.${bibFormat}`;
  const url = `http://127.0.0.1:23119/better-bibtex/collection?/${libraryId}/${collectionId}.${bibFormat}`;
  const options = {
    hostname: "localhost",
    port: 23119,
    path: url_path,
    method: "GET",
    headers: {
      "Content-Type": "application/json"
    }
  };
  const responseStr = await makeHttpRequest(options);
  const responseJson = JSON.parse(responseStr);
  return responseJson;
}
async function exportCollectionPath(collectionPath, bibFormat = "betterbibtex") {
  try {
    const coll = await locateCollection(collectionPath);
    const exported_collection = await exportCollection(coll.collectionId, coll.libraryId, bibFormat);
    return exported_collection;
  } catch (error) {
    console.error("Error:", error);
  }
}
async function collectionCitekeysTitles(collectionPath) {
  const resultJson = await exportCollectionPath(collectionPath, "json");
  const result_keys_title = resultJson.map((item) => {
    return { "id": item.id, "title": item.title };
  });
  return result_keys_title;
}
var CitationSuggest = class extends import_obsidian.EditorSuggest {
  constructor(app, plugin) {
    super(app);
    this.app = app;
    this.plugin = plugin;
    this.justCompleted = false;
  }
  onTrigger(cursor, editor, file) {
    var _a, _b;
    if (this.justCompleted) {
      this.justCompleted = false;
      return null;
    }
    const triggerPhrase = "@";
    const startPos = ((_a = this.context) == null ? void 0 : _a.start) || {
      line: cursor.line,
      ch: cursor.ch - triggerPhrase.length
    };
    const lineToCursor = editor.getRange(
      { line: startPos.line, ch: 0 },
      { line: startPos.line, ch: cursor.ch }
    );
    if (lineToCursor.lastIndexOf("[") == -1) {
      return null;
    } else {
      if (lineToCursor.lastIndexOf("[") < lineToCursor.lastIndexOf("]")) {
        return null;
      } else {
      }
      ;
    }
    const OpenBracketToCursor = lineToCursor.substring(lineToCursor.lastIndexOf("[") + 1);
    const precedingChar = editor.getRange(
      { line: startPos.line, ch: cursor.ch - 1 },
      { line: startPos.line, ch: cursor.ch }
    );
    const followingChar = editor.getRange(
      { line: startPos.line, ch: cursor.ch },
      { line: startPos.line, ch: cursor.ch + 1 }
    );
    if (!OpenBracketToCursor.startsWith("@")) {
      return null;
    }
    if (precedingChar == " " || precedingChar == ";") {
      return null;
    }
    const LastAtSignToCursor = OpenBracketToCursor.substring(OpenBracketToCursor.lastIndexOf("@") + 1);
    console.log(LastAtSignToCursor);
    const LastAtSignLinePos = lineToCursor.lastIndexOf("@");
    const queryStartPos = ((_b = this.context) == null ? void 0 : _b.start) || {
      line: cursor.line,
      ch: LastAtSignLinePos
    };
    const noteFile = file;
    const frontMatter = this.app.metadataCache.getFileCache(noteFile).frontmatter;
    this.zotero_collection = frontMatter.zotero_collection;
    const query = LastAtSignToCursor;
    console.log({
      start: queryStartPos,
      end: cursor,
      query
    });
    return {
      start: queryStartPos,
      end: cursor,
      query
    };
  }
  async getSuggestions(context) {
    const suggestions = await collectionCitekeysTitles(this.zotero_collection);
    if (suggestions.length) {
      return suggestions.filter(
        (item) => item["id"].startsWith(context.query)
      );
    }
    return [{ label: context.query }];
  }
  renderSuggestion(suggestion, el) {
    el.setText("@" + suggestion["id"]);
    el.innerHTML += "<br>";
    el.append(suggestion["title"]);
  }
  selectSuggestion(suggestion, event) {
    const { editor } = this.context;
    const precedingChar = editor.getRange(
      { line: this.context.start.line, ch: this.context.start.ch - 1 },
      { line: this.context.start.line, ch: this.context.start.ch }
    );
    const followingChar = editor.getRange(
      { line: this.context.start.line, ch: this.context.end.ch },
      { line: this.context.start.line, ch: this.context.end.ch + 1 }
    );
    const suggStr = "@" + suggestion.id;
    let cursorEndPos = null;
    if (followingChar == "]") {
      cursorEndPos = this.context.start.ch + suggStr.length + 1;
    } else {
      cursorEndPos = this.context.start.ch + suggStr.length;
    }
    editor.replaceRange(suggStr, this.context.start, { "line": this.context.end.line, "ch": this.context.end.ch });
    editor.setCursor({ "line": this.context.start.line, "ch": cursorEndPos });
    this.justCompleted = true;
  }
};

// main.ts
var DEFAULT_SETTINGS = {
  mySetting: "default"
};
var BibcitePlugin = class extends import_obsidian2.Plugin {
  async onload() {
    await this.loadSettings();
    this.registerEditorSuggest(new CitationSuggest(this.app, this));
  }
  onunload() {
  }
  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }
  async saveSettings() {
    await this.saveData(this.settings);
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyIsICJDaXRhdGlvblN1Z2dlc3QudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImltcG9ydCB7IEFwcCwgRWRpdG9yLCBNYXJrZG93blZpZXcsIE1vZGFsLCBOb3RpY2UsIFBsdWdpbiwgUGx1Z2luU2V0dGluZ1RhYiwgU2V0dGluZyB9IGZyb20gJ29ic2lkaWFuJztcblxuaW1wb3J0IHsgQ2l0YXRpb25TdWdnZXN0IH0gZnJvbSBcIkNpdGF0aW9uU3VnZ2VzdC50c1wiO1xuXG4vLyBSZW1lbWJlciB0byByZW5hbWUgdGhlc2UgY2xhc3NlcyBhbmQgaW50ZXJmYWNlcyFcblxuaW50ZXJmYWNlIEJpYmNpdGVQbHVnaW5TZXR0aW5ncyB7XG5cdG15U2V0dGluZzogc3RyaW5nO1xufVxuXG5jb25zdCBERUZBVUxUX1NFVFRJTkdTOiBCaWJjaXRlUGx1Z2luU2V0dGluZ3MgPSB7XG5cdG15U2V0dGluZzogJ2RlZmF1bHQnXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJpYmNpdGVQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xuXHRzZXR0aW5nczogQmliY2l0ZVBsdWdpblNldHRpbmdzO1xuXG5cdGFzeW5jIG9ubG9hZCgpIHtcblx0XHRhd2FpdCB0aGlzLmxvYWRTZXR0aW5ncygpO1xuXG5cdFx0dGhpcy5yZWdpc3RlckVkaXRvclN1Z2dlc3QobmV3IENpdGF0aW9uU3VnZ2VzdCh0aGlzLmFwcCwgdGhpcykpO1xuXG5cdFx0Lypcblx0XHQvLyBUaGlzIGNyZWF0ZXMgYW4gaWNvbiBpbiB0aGUgbGVmdCByaWJib24uXG5cdFx0Y29uc3QgcmliYm9uSWNvbkVsID0gdGhpcy5hZGRSaWJib25JY29uKCdkaWNlJywgJ1NhbXBsZSBQbHVnaW4nLCAoZXZ0OiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHQvLyBDYWxsZWQgd2hlbiB0aGUgdXNlciBjbGlja3MgdGhlIGljb24uXG5cdFx0XHRuZXcgTm90aWNlKCdUaGlzIGlzIGEgbm90aWNlIScpO1xuXHRcdH0pO1xuXHRcdC8vIFBlcmZvcm0gYWRkaXRpb25hbCB0aGluZ3Mgd2l0aCB0aGUgcmliYm9uXG5cdFx0cmliYm9uSWNvbkVsLmFkZENsYXNzKCdteS1wbHVnaW4tcmliYm9uLWNsYXNzJyk7XG5cblx0XHQvLyBUaGlzIGFkZHMgYSBzdGF0dXMgYmFyIGl0ZW0gdG8gdGhlIGJvdHRvbSBvZiB0aGUgYXBwLiBEb2VzIG5vdCB3b3JrIG9uIG1vYmlsZSBhcHBzLlxuXHRcdGNvbnN0IHN0YXR1c0Jhckl0ZW1FbCA9IHRoaXMuYWRkU3RhdHVzQmFySXRlbSgpO1xuXHRcdHN0YXR1c0Jhckl0ZW1FbC5zZXRUZXh0KCdTdGF0dXMgQmFyIFRleHQnKTtcblxuXHRcdC8vIFRoaXMgYWRkcyBhIHNpbXBsZSBjb21tYW5kIHRoYXQgY2FuIGJlIHRyaWdnZXJlZCBhbnl3aGVyZVxuXHRcdHRoaXMuYWRkQ29tbWFuZCh7XG5cdFx0XHRpZDogJ29wZW4tc2FtcGxlLW1vZGFsLXNpbXBsZScsXG5cdFx0XHRuYW1lOiAnT3BlbiBzYW1wbGUgbW9kYWwgKHNpbXBsZSknLFxuXHRcdFx0Y2FsbGJhY2s6ICgpID0+IHtcblx0XHRcdFx0bmV3IFNhbXBsZU1vZGFsKHRoaXMuYXBwKS5vcGVuKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0Ly8gVGhpcyBhZGRzIGFuIGVkaXRvciBjb21tYW5kIHRoYXQgY2FuIHBlcmZvcm0gc29tZSBvcGVyYXRpb24gb24gdGhlIGN1cnJlbnQgZWRpdG9yIGluc3RhbmNlXG5cdFx0dGhpcy5hZGRDb21tYW5kKHtcblx0XHRcdGlkOiAnc2FtcGxlLWVkaXRvci1jb21tYW5kJyxcblx0XHRcdG5hbWU6ICdTYW1wbGUgZWRpdG9yIGNvbW1hbmQnLFxuXHRcdFx0ZWRpdG9yQ2FsbGJhY2s6IChlZGl0b3I6IEVkaXRvciwgdmlldzogTWFya2Rvd25WaWV3KSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGVkaXRvci5nZXRTZWxlY3Rpb24oKSk7XG5cdFx0XHRcdGVkaXRvci5yZXBsYWNlU2VsZWN0aW9uKCdTYW1wbGUgRWRpdG9yIENvbW1hbmQnKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHQvLyBUaGlzIGFkZHMgYSBjb21wbGV4IGNvbW1hbmQgdGhhdCBjYW4gY2hlY2sgd2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgYXBwIGFsbG93cyBleGVjdXRpb24gb2YgdGhlIGNvbW1hbmRcblx0XHR0aGlzLmFkZENvbW1hbmQoe1xuXHRcdFx0aWQ6ICdvcGVuLXNhbXBsZS1tb2RhbC1jb21wbGV4Jyxcblx0XHRcdG5hbWU6ICdPcGVuIHNhbXBsZSBtb2RhbCAoY29tcGxleCknLFxuXHRcdFx0Y2hlY2tDYWxsYmFjazogKGNoZWNraW5nOiBib29sZWFuKSA9PiB7XG5cdFx0XHRcdC8vIENvbmRpdGlvbnMgdG8gY2hlY2tcblx0XHRcdFx0Y29uc3QgbWFya2Rvd25WaWV3ID0gdGhpcy5hcHAud29ya3NwYWNlLmdldEFjdGl2ZVZpZXdPZlR5cGUoTWFya2Rvd25WaWV3KTtcblx0XHRcdFx0aWYgKG1hcmtkb3duVmlldykge1xuXHRcdFx0XHRcdC8vIElmIGNoZWNraW5nIGlzIHRydWUsIHdlJ3JlIHNpbXBseSBcImNoZWNraW5nXCIgaWYgdGhlIGNvbW1hbmQgY2FuIGJlIHJ1bi5cblx0XHRcdFx0XHQvLyBJZiBjaGVja2luZyBpcyBmYWxzZSwgdGhlbiB3ZSB3YW50IHRvIGFjdHVhbGx5IHBlcmZvcm0gdGhlIG9wZXJhdGlvbi5cblx0XHRcdFx0XHRpZiAoIWNoZWNraW5nKSB7XG5cdFx0XHRcdFx0XHRuZXcgU2FtcGxlTW9kYWwodGhpcy5hcHApLm9wZW4oKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBUaGlzIGNvbW1hbmQgd2lsbCBvbmx5IHNob3cgdXAgaW4gQ29tbWFuZCBQYWxldHRlIHdoZW4gdGhlIGNoZWNrIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZVxuXHRcdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHQvLyBUaGlzIGFkZHMgYSBzZXR0aW5ncyB0YWIgc28gdGhlIHVzZXIgY2FuIGNvbmZpZ3VyZSB2YXJpb3VzIGFzcGVjdHMgb2YgdGhlIHBsdWdpblxuXHRcdHRoaXMuYWRkU2V0dGluZ1RhYihuZXcgU2FtcGxlU2V0dGluZ1RhYih0aGlzLmFwcCwgdGhpcykpO1xuXG5cdFx0Ly8gSWYgdGhlIHBsdWdpbiBob29rcyB1cCBhbnkgZ2xvYmFsIERPTSBldmVudHMgKG9uIHBhcnRzIG9mIHRoZSBhcHAgdGhhdCBkb2Vzbid0IGJlbG9uZyB0byB0aGlzIHBsdWdpbilcblx0XHQvLyBVc2luZyB0aGlzIGZ1bmN0aW9uIHdpbGwgYXV0b21hdGljYWxseSByZW1vdmUgdGhlIGV2ZW50IGxpc3RlbmVyIHdoZW4gdGhpcyBwbHVnaW4gaXMgZGlzYWJsZWQuXG5cdFx0dGhpcy5yZWdpc3RlckRvbUV2ZW50KGRvY3VtZW50LCAnY2xpY2snLCAoZXZ0OiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZygnY2xpY2snLCBldnQpO1xuXHRcdH0pO1xuXG5cdFx0Ly8gV2hlbiByZWdpc3RlcmluZyBpbnRlcnZhbHMsIHRoaXMgZnVuY3Rpb24gd2lsbCBhdXRvbWF0aWNhbGx5IGNsZWFyIHRoZSBpbnRlcnZhbCB3aGVuIHRoZSBwbHVnaW4gaXMgZGlzYWJsZWQuXG5cdFx0dGhpcy5yZWdpc3RlckludGVydmFsKHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiBjb25zb2xlLmxvZygnc2V0SW50ZXJ2YWwnKSwgNSAqIDYwICogMTAwMCkpO1xuXHRcdCovXG5cblx0fVxuXG5cdG9udW5sb2FkKCkge1xuXG5cdH1cblxuXHRhc3luYyBsb2FkU2V0dGluZ3MoKSB7XG5cdFx0dGhpcy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfU0VUVElOR1MsIGF3YWl0IHRoaXMubG9hZERhdGEoKSk7XG5cdH1cblxuXHRhc3luYyBzYXZlU2V0dGluZ3MoKSB7XG5cdFx0YXdhaXQgdGhpcy5zYXZlRGF0YSh0aGlzLnNldHRpbmdzKTtcblx0fVxufVxuXG5jbGFzcyBTYW1wbGVNb2RhbCBleHRlbmRzIE1vZGFsIHtcblx0Y29uc3RydWN0b3IoYXBwOiBBcHApIHtcblx0XHRzdXBlcihhcHApO1xuXHR9XG5cblx0b25PcGVuKCkge1xuXHRcdGNvbnN0IHtjb250ZW50RWx9ID0gdGhpcztcblx0XHRjb250ZW50RWwuc2V0VGV4dCgnV29haCEnKTtcblx0fVxuXG5cdG9uQ2xvc2UoKSB7XG5cdFx0Y29uc3Qge2NvbnRlbnRFbH0gPSB0aGlzO1xuXHRcdGNvbnRlbnRFbC5lbXB0eSgpO1xuXHR9XG59XG5cbmNsYXNzIFNhbXBsZVNldHRpbmdUYWIgZXh0ZW5kcyBQbHVnaW5TZXR0aW5nVGFiIHtcblx0cGx1Z2luOiBNeVBsdWdpbjtcblxuXHRjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcGx1Z2luOiBNeVBsdWdpbikge1xuXHRcdHN1cGVyKGFwcCwgcGx1Z2luKTtcblx0XHR0aGlzLnBsdWdpbiA9IHBsdWdpbjtcblx0fVxuXG5cdGRpc3BsYXkoKTogdm9pZCB7XG5cdFx0Y29uc3Qge2NvbnRhaW5lckVsfSA9IHRoaXM7XG5cblx0XHRjb250YWluZXJFbC5lbXB0eSgpO1xuXG5cdFx0bmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG5cdFx0XHQuc2V0TmFtZSgnU2V0dGluZyAjMScpXG5cdFx0XHQuc2V0RGVzYygnSXRcXCdzIGEgc2VjcmV0Jylcblx0XHRcdC5hZGRUZXh0KHRleHQgPT4gdGV4dFxuXHRcdFx0XHQuc2V0UGxhY2Vob2xkZXIoJ0VudGVyIHlvdXIgc2VjcmV0Jylcblx0XHRcdFx0LnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLm15U2V0dGluZylcblx0XHRcdFx0Lm9uQ2hhbmdlKGFzeW5jICh2YWx1ZSkgPT4ge1xuXHRcdFx0XHRcdHRoaXMucGx1Z2luLnNldHRpbmdzLm15U2V0dGluZyA9IHZhbHVlO1xuXHRcdFx0XHRcdGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xuXHRcdFx0XHR9KSk7XG5cdH1cbn1cbiIsICJpbXBvcnQge1xuXHRBcHAsXG5cdEVkaXRvcixcblx0RWRpdG9yUG9zaXRpb24sXG5cdEVkaXRvclN1Z2dlc3QsXG5cdEVkaXRvclN1Z2dlc3RDb250ZXh0LFxuXHRFZGl0b3JTdWdnZXN0VHJpZ2dlckluZm8sXG5cdE1hcmtkb3duVmlldyxcblx0VEZpbGUsXG5cdHJlcXVlc3QsXG5cdHJlcXVlc3RVcmxcbn0gZnJvbSAnb2JzaWRpYW4nO1xuXG5pbXBvcnQgQmliY2l0ZVBsdWdpbiBmcm9tICdtYWluJztcbi8vaW1wb3J0IHtleHBvcnRDb2xsZWN0aW9uLCBleHBvcnRDb2xsZWN0aW9uUGF0aCwgY29sbGVjdGlvbkNpdGVrZXlzLCBsb2NhdGVDb2xsZWN0aW9ufSBmcm9tICdab3Rlcm9GdW5jdGlvbnMuanMnO1xuXG5pbnRlcmZhY2UgU3VnZ2VzdGlvbiB7XG5cdHF1ZXJ5OiBzdHJpbmc7XG5cdHN0YXJ0SW5kZXg6IG51bWJlcjtcblx0bGFiZWw6IHN0cmluZztcbn1cblxuXG5jb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cCcpO1xuXG5mdW5jdGlvbiBtYWtlSHR0cFJlcXVlc3Qob3B0aW9ucywgZGF0YSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcSA9IGh0dHAucmVxdWVzdChvcHRpb25zLCAocmVzKSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVzcG9uc2VEYXRhID0gJyc7XG5cbiAgICAgICAgICAgIHJlcy5vbignZGF0YScsIChjaHVuaykgPT4ge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YSArPSBjaHVuaztcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXMub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlRGF0YSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIHJlcS53cml0ZShkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlcS5lbmQoKTtcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9jYXRlQ29sbGVjdGlvbihjb2xsZWN0aW9uUGF0aCkge1xuICAgIGNvbnN0IGpzb25ScGNEYXRhID0ge1xuICAgICAgICBqc29ucnBjOiBcIjIuMFwiLFxuICAgICAgICBtZXRob2Q6IFwidXNlci5ncm91cHNcIixcbiAgICAgICAgcGFyYW1zOiBbdHJ1ZV1cbiAgICB9O1xuXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgaG9zdG5hbWU6ICdsb2NhbGhvc3QnLFxuICAgICAgICBwb3J0OiAyMzExOSxcbiAgICAgICAgcGF0aDogJy9iZXR0ZXItYmlidGV4L2pzb24tcnBjJyxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG5cdFx0XHQnQ29udGVudC1MZW5ndGgnOiBKU09OLnN0cmluZ2lmeShqc29uUnBjRGF0YSkubGVuZ3RoXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3BvbnNlU3RyID0gYXdhaXQgbWFrZUh0dHBSZXF1ZXN0KG9wdGlvbnMsIEpTT04uc3RyaW5naWZ5KGpzb25ScGNEYXRhKSk7XG5cdGNvbnN0IHJlc3BvbnNlSnNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VTdHIpO1xuICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlSnNvbi5yZXN1bHQ7XG5cblxuICAgIGNvbnN0IHBsaXN0ID0gY29sbGVjdGlvblBhdGguc3BsaXQoXCIvXCIpO1xuICAgIGNvbnN0IGxpYiA9IHBsaXN0WzBdO1xuICAgIGNvbnN0IGFmdGVyID0gcGxpc3Quc2xpY2UoMSk7XG5cbiAgICBjb25zdCBsaWJOYW1lcyA9IHJlc3VsdC5tYXAobCA9PiBsLm5hbWUpO1xuICAgIGNvbnN0IGxpYklkcyA9IHJlc3VsdC5tYXAobCA9PiBsLmlkKTtcblxuICAgIGNvbnN0IG1hdGNoZWRMaWIgPSByZXN1bHRbbGliTmFtZXMuaW5kZXhPZihsaWIpXTtcbiAgICBjb25zdCBtYXRjaGVkTGliSWQgPSBsaWJJZHNbbGliTmFtZXMuaW5kZXhPZihsaWIpXTtcblxuICAgIGNvbnN0IGFsbENvbGxlY3Rpb25zID0gbWF0Y2hlZExpYi5jb2xsZWN0aW9ucztcbiAgICBjb25zdCBhbGxDb2xsZWN0aW9uc0RpY3QgPSB7fTtcbiAgICBhbGxDb2xsZWN0aW9ucy5mb3JFYWNoKGMgPT4ge1xuICAgICAgICBhbGxDb2xsZWN0aW9uc0RpY3RbYy5rZXldID0geyAuLi5jLCBjaGlsZHJlbjogW10gfTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHRvcENvbGxlY3Rpb25zID0gYWxsQ29sbGVjdGlvbnMuZmlsdGVyKGMgPT4gIWMucGFyZW50Q29sbGVjdGlvbik7XG4gICAgY29uc3QgdG9wQ29sbGVjdGlvbnNEaWN0ID0ge307XG4gICAgdG9wQ29sbGVjdGlvbnMuZm9yRWFjaChjID0+IHtcbiAgICAgICAgdG9wQ29sbGVjdGlvbnNEaWN0W2Mua2V5XSA9IHsgLi4uYywgY2hpbGRyZW46IFtdIH07XG4gICAgfSk7XG5cbiAgICBjb25zdCBub25Ub3BDb2xsZWN0aW9ucyA9IG1hdGNoZWRMaWIuY29sbGVjdGlvbnMuZmlsdGVyKGMgPT4gYy5wYXJlbnRDb2xsZWN0aW9uICE9PSBmYWxzZSk7XG5cbiAgICBmb3IgKGNvbnN0IGNvbGwgb2Ygbm9uVG9wQ29sbGVjdGlvbnMpIHtcbiAgICAgICAgaWYgKGNvbGwucGFyZW50Q29sbGVjdGlvbiBpbiB0b3BDb2xsZWN0aW9uc0RpY3QpIHtcbiAgICAgICAgICAgIHRvcENvbGxlY3Rpb25zRGljdFtjb2xsLnBhcmVudENvbGxlY3Rpb25dLmNoaWxkcmVuLnB1c2goY29sbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBtYXRjaGVkVG9wQ29sbGVjdGlvbiA9IHRvcENvbGxlY3Rpb25zLmZpbmQoYyA9PiBjLm5hbWUgPT09IGFmdGVyWzBdKTtcbiAgICBjb25zdCBtYXRjaGVkVG9wQ29sbGVjdGlvbktleSA9IG1hdGNoZWRUb3BDb2xsZWN0aW9uLmtleTtcblxuXG4gICAgbGV0IGNoaWxkcmVuID0gT2JqZWN0LnZhbHVlcyhhbGxDb2xsZWN0aW9uc0RpY3QpLmZpbHRlcihjID0+IGMucGFyZW50Q29sbGVjdGlvbiA9PT0gbWF0Y2hlZFRvcENvbGxlY3Rpb25LZXkpO1xuICAgIGxldCBtYXRjaGVkQ2hpbGRDb2xsZWN0aW9uS2V5ID0gbnVsbDtcblxuXG4gICAgZm9yIChjb25zdCBjbmFtZSBvZiBhZnRlci5zbGljZSgxKSkge1xuICAgICAgICBpZiAobWF0Y2hlZENoaWxkQ29sbGVjdGlvbktleSkge1xuICAgICAgICAgICAgY2hpbGRyZW4gPSBPYmplY3QudmFsdWVzKGFsbENvbGxlY3Rpb25zRGljdCkuZmlsdGVyKGMgPT4gYy5wYXJlbnRDb2xsZWN0aW9uID09PSBtYXRjaGVkQ2hpbGRDb2xsZWN0aW9uS2V5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY2hpbGRyZW4pIHtcblxuXHRcdFx0aWYgKGNuYW1lID09PSBjaGlsZC5uYW1lKSB7XG4gICAgICAgICAgICAgICAgbWF0Y2hlZENoaWxkQ29sbGVjdGlvbktleSA9IGNoaWxkLmtleTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGxpYnJhcnlJZDogbWF0Y2hlZExpYklkLCBjb2xsZWN0aW9uSWQ6IG1hdGNoZWRDaGlsZENvbGxlY3Rpb25LZXkgfTtcbn1cblxuXG5hc3luYyBmdW5jdGlvbiBleHBvcnRDb2xsZWN0aW9uKGNvbGxlY3Rpb25JZCwgbGlicmFyeUlkLCBiaWJGb3JtYXQgPSAnYmV0dGVyYmlidGV4Jykge1xuXG5cdGNvbnN0IHVybF9wYXRoID0gYC9iZXR0ZXItYmlidGV4L2NvbGxlY3Rpb24/LyR7bGlicmFyeUlkfS8ke2NvbGxlY3Rpb25JZH0uJHtiaWJGb3JtYXR9YDtcblxuICAgIGNvbnN0IHVybCA9IGBodHRwOi8vMTI3LjAuMC4xOjIzMTE5L2JldHRlci1iaWJ0ZXgvY29sbGVjdGlvbj8vJHtsaWJyYXJ5SWR9LyR7Y29sbGVjdGlvbklkfS4ke2JpYkZvcm1hdH1gO1xuXG5cdGNvbnN0IG9wdGlvbnMgPSB7XG5cdFx0aG9zdG5hbWU6ICdsb2NhbGhvc3QnLFxuXHRcdHBvcnQ6IDIzMTE5LFxuXHRcdHBhdGg6IHVybF9wYXRoLFxuXHRcdG1ldGhvZDogJ0dFVCcsXG5cdFx0aGVhZGVyczoge1xuXHRcdFx0J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcblx0XHRcdH0sXG5cdH07XG5cbiAgICBjb25zdCByZXNwb25zZVN0ciA9IGF3YWl0IG1ha2VIdHRwUmVxdWVzdChvcHRpb25zKVxuXG5cdGNvbnN0IHJlc3BvbnNlSnNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VTdHIpO1xuXG5cdHJldHVybiByZXNwb25zZUpzb247XG5cbn1cblxuYXN5bmMgZnVuY3Rpb24gYXR0YWNobWVudHMoY2l0ZUtleSkge1xuXG4gICAgY29uc3QganNvblJwY0RhdGEgPSB7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIG1ldGhvZDogXCJpdGVtLmF0dGFjaG1lbnRzXCIsXG4gICAgICAgIHBhcmFtczogW2NpdGVLZXldXG4gICAgfTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIGhvc3RuYW1lOiAnbG9jYWxob3N0JyxcbiAgICAgICAgcG9ydDogMjMxMTksXG4gICAgICAgIHBhdGg6ICcvYmV0dGVyLWJpYnRleC9qc29uLXJwYycsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuXHRcdFx0J0NvbnRlbnQtTGVuZ3RoJzogSlNPTi5zdHJpbmdpZnkoanNvblJwY0RhdGEpLmxlbmd0aFxuICAgICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCByZXNwb25zZVN0ciA9IGF3YWl0IG1ha2VIdHRwUmVxdWVzdChvcHRpb25zLCBKU09OLnN0cmluZ2lmeShqc29uUnBjRGF0YSkpO1xuXG5cdGNvbnN0IHJlc3BvbnNlSnNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VTdHIpO1xuXG5cdHJldHVybiByZXNwb25zZUpzb247XG5cbn1cblxuYXN5bmMgZnVuY3Rpb24gZXhwb3J0Q29sbGVjdGlvblBhdGgoY29sbGVjdGlvblBhdGgsIGJpYkZvcm1hdCA9ICdiZXR0ZXJiaWJ0ZXgnKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY29sbCA9IGF3YWl0IGxvY2F0ZUNvbGxlY3Rpb24oY29sbGVjdGlvblBhdGgpXG4gICAgICAgIGNvbnN0IGV4cG9ydGVkX2NvbGxlY3Rpb24gPSBhd2FpdCBleHBvcnRDb2xsZWN0aW9uKGNvbGwuY29sbGVjdGlvbklkLCBjb2xsLmxpYnJhcnlJZCwgYmliRm9ybWF0KTtcblx0XHRyZXR1cm4gZXhwb3J0ZWRfY29sbGVjdGlvbjtcblxuXHR9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjb2xsZWN0aW9uQ2l0ZWtleXMoY29sbGVjdGlvblBhdGgpIHtcbiAgICBjb25zdCByZXN1bHRKc29uID0gYXdhaXQgZXhwb3J0Q29sbGVjdGlvblBhdGgoY29sbGVjdGlvblBhdGgsIFwianNvblwiKTtcbiAgICByZXR1cm4gcmVzdWx0SnNvbi5tYXAoaXRlbSA9PiBpdGVtLmlkKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29sbGVjdGlvbkNpdGVrZXlzVGl0bGVzKGNvbGxlY3Rpb25QYXRoKSB7XG4gICAgY29uc3QgcmVzdWx0SnNvbiA9IGF3YWl0IGV4cG9ydENvbGxlY3Rpb25QYXRoKGNvbGxlY3Rpb25QYXRoLCBcImpzb25cIik7XG4gICAgY29uc3QgcmVzdWx0X2tleXNfdGl0bGUgPSByZXN1bHRKc29uLm1hcChpdGVtID0+IHtyZXR1cm4geydpZCc6IGl0ZW0uaWQsICd0aXRsZSc6IGl0ZW0udGl0bGV9IH0pO1xuXHRyZXR1cm4gcmVzdWx0X2tleXNfdGl0bGU7XG59XG5cbmV4cG9ydCBjbGFzcyBDaXRhdGlvblN1Z2dlc3QgZXh0ZW5kcyBFZGl0b3JTdWdnZXN0PFN1Z2dlc3Rpb24+IHtcblx0cHJpdmF0ZSBwbHVnaW46IEJpYmNpdGVQbHVnaW47XG5cdHByaXZhdGUgcmVhZG9ubHkgYXBwOiBBcHA7XG5cdHByaXZhdGUganVzdENvbXBsZXRlZDogYm9vbGVhbjtcblx0cHJpdmF0ZSB6b3Rlcm9fY29sbGVjdGlvbjogc3RyaW5nO1xuXG5cdGNvbnN0cnVjdG9yKGFwcDogQXBwLCBwbHVnaW46IEJpYmNpdGVQbHVnaW4pIHtcblx0XHRzdXBlcihhcHApO1xuXHRcdHRoaXMuYXBwID0gYXBwO1xuXHRcdHRoaXMucGx1Z2luID0gcGx1Z2luO1xuXHRcdHRoaXMuanVzdENvbXBsZXRlZCA9IGZhbHNlO1xuXHR9XG5cdG9uVHJpZ2dlcihcblx0XHRjdXJzb3I6IEVkaXRvclBvc2l0aW9uLFxuXHRcdGVkaXRvcjogRWRpdG9yLFxuXHRcdGZpbGU6IFRGaWxlXG5cdCk6IEVkaXRvclN1Z2dlc3RUcmlnZ2VySW5mbyB8IG51bGwge1xuXG5cdFx0aWYgKHRoaXMuanVzdENvbXBsZXRlZCkge1xuXHRcdFx0dGhpcy5qdXN0Q29tcGxldGVkID0gZmFsc2U7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cblxuICAgICAgICBjb25zdCB0cmlnZ2VyUGhyYXNlID0gJ0AnO1xuICAgICAgICBjb25zdCBzdGFydFBvcyA9IHRoaXMuY29udGV4dD8uc3RhcnQgfHwge1xuXHRcdFx0bGluZTogY3Vyc29yLmxpbmUsXG5cdFx0XHRjaDogY3Vyc29yLmNoIC0gdHJpZ2dlclBocmFzZS5sZW5ndGgsXG5cdFx0fTtcblxuXHRcdGNvbnN0IGxpbmVUb0N1cnNvciA9IGVkaXRvci5nZXRSYW5nZSh7bGluZTogc3RhcnRQb3MubGluZSwgY2g6IDB9LFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCAge2xpbmU6IHN0YXJ0UG9zLmxpbmUsIGNoOiBjdXJzb3IuY2h9KTtcblxuXHRcdGlmIChsaW5lVG9DdXJzb3IubGFzdEluZGV4T2YoXCJbXCIpID09IC0xKSB7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWYgKGxpbmVUb0N1cnNvci5sYXN0SW5kZXhPZihcIltcIikgPCBsaW5lVG9DdXJzb3IubGFzdEluZGV4T2YoXCJdXCIpKXtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9IGVsc2Uge1xuXG5cdFx0XHR9O1xuXHRcdH1cblxuXHRcdGNvbnN0IE9wZW5CcmFja2V0VG9DdXJzb3IgPSBsaW5lVG9DdXJzb3Iuc3Vic3RyaW5nKGxpbmVUb0N1cnNvci5sYXN0SW5kZXhPZihcIltcIikrMSlcblxuXHRcdGNvbnN0IHByZWNlZGluZ0NoYXIgPSBlZGl0b3IuZ2V0UmFuZ2Uoe2xpbmU6IHN0YXJ0UG9zLmxpbmUsIGNoOiBjdXJzb3IuY2ggLSAxfSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQgIHtsaW5lOiBzdGFydFBvcy5saW5lLCBjaDogY3Vyc29yLmNofSk7XG5cblx0XHRjb25zdCBmb2xsb3dpbmdDaGFyID0gZWRpdG9yLmdldFJhbmdlKHtsaW5lOiBzdGFydFBvcy5saW5lLCBjaDogY3Vyc29yLmNofSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQgIHtsaW5lOiBzdGFydFBvcy5saW5lLCBjaDogY3Vyc29yLmNoICsgMX0pO1xuXG5cblx0XHRpZiAoIU9wZW5CcmFja2V0VG9DdXJzb3Iuc3RhcnRzV2l0aChcIkBcIikpIHtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblxuXHRcdGlmICgocHJlY2VkaW5nQ2hhciA9PSBcIiBcIikgfHwgKHByZWNlZGluZ0NoYXIgPT0gXCI7XCIpKSB7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cblx0XHRjb25zdCBMYXN0QXRTaWduVG9DdXJzb3IgPSBPcGVuQnJhY2tldFRvQ3Vyc29yLnN1YnN0cmluZyhPcGVuQnJhY2tldFRvQ3Vyc29yLmxhc3RJbmRleE9mKFwiQFwiKSsxKVxuXHRcdGNvbnNvbGUubG9nKExhc3RBdFNpZ25Ub0N1cnNvcik7XG5cblx0XHRjb25zdCBMYXN0QXRTaWduTGluZVBvcyA9IGxpbmVUb0N1cnNvci5sYXN0SW5kZXhPZihcIkBcIik7XG5cblx0XHRjb25zdCBxdWVyeVN0YXJ0UG9zID0gdGhpcy5jb250ZXh0Py5zdGFydCB8fCB7XG5cdFx0XHRsaW5lOiBjdXJzb3IubGluZSxcblx0XHRcdGNoOiBMYXN0QXRTaWduTGluZVBvcyxcblx0XHR9O1xuXG5cdFx0Y29uc3Qgbm90ZUZpbGUgPSBmaWxlO1xuXHRcdGNvbnN0IGZyb250TWF0dGVyID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUobm90ZUZpbGUpLmZyb250bWF0dGVyO1xuXG5cdFx0dGhpcy56b3Rlcm9fY29sbGVjdGlvbiA9IGZyb250TWF0dGVyLnpvdGVyb19jb2xsZWN0aW9uXG5cblx0XHRjb25zdCBxdWVyeSA9IExhc3RBdFNpZ25Ub0N1cnNvcjtcblxuXHRcdGNvbnNvbGUubG9nKHtcbiAgICAgICAgICAgIHN0YXJ0OiBxdWVyeVN0YXJ0UG9zLFxuICAgICAgICAgICAgZW5kOiBjdXJzb3IsXG4gICAgICAgICAgICBxdWVyeTogcXVlcnksXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGFydDogcXVlcnlTdGFydFBvcyxcbiAgICAgICAgICAgIGVuZDogY3Vyc29yLFxuICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LFxuICAgICAgICAgICAgfTtcblxuICAgIH1cblxuXHRhc3luYyBnZXRTdWdnZXN0aW9ucyhjb250ZXh0OiBFZGl0b3JTdWdnZXN0Q29udGV4dCk6IFN1Z2dlc3Rpb25bXSB7XG5cblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IGF3YWl0IGNvbGxlY3Rpb25DaXRla2V5c1RpdGxlcyh0aGlzLnpvdGVyb19jb2xsZWN0aW9uKVxuXG4gICAgICAgIGlmIChzdWdnZXN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBzdWdnZXN0aW9ucy5maWx0ZXIoXG5cdFx0XHRcdFx0XHQoaXRlbSkgPT4gaXRlbVsnaWQnXS5zdGFydHNXaXRoKGNvbnRleHQucXVlcnkpXG5cdFx0XHRcdFx0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNhdGNoLWFsbCBpZiB0aGVyZSBhcmUgbm8gbWF0Y2hlc1xuICAgICAgICByZXR1cm4gW3sgbGFiZWw6IGNvbnRleHQucXVlcnkgfV07XG4gICAgfVxuXG5cdHJlbmRlclN1Z2dlc3Rpb24oc3VnZ2VzdGlvbjogU3VnZ2VzdGlvbiwgZWw6IEhUTUxFbGVtZW50KTogdm9pZCB7XG5cdFx0ZWwuc2V0VGV4dCgnQCcgKyBzdWdnZXN0aW9uWydpZCddKTtcblx0XHRlbC5pbm5lckhUTUwgKz0gJzxicj4nO1xuXHRcdGVsLmFwcGVuZChzdWdnZXN0aW9uWyd0aXRsZSddKTtcblx0fVxuXG5cdHNlbGVjdFN1Z2dlc3Rpb24oc3VnZ2VzdGlvbjogU3VnZ2VzdGlvbiwgZXZlbnQ6IEtleWJvYXJkRXZlbnQgfCBNb3VzZUV2ZW50KTogdm9pZCB7XG5cdFx0Y29uc3QgeyBlZGl0b3IgfSA9IHRoaXMuY29udGV4dDtcblxuXHRcdGNvbnN0IHByZWNlZGluZ0NoYXIgPSBlZGl0b3IuZ2V0UmFuZ2Uoe2xpbmU6IHRoaXMuY29udGV4dC5zdGFydC5saW5lLCBjaDogdGhpcy5jb250ZXh0LnN0YXJ0LmNoIC0gMX0sXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0ICB7bGluZTogdGhpcy5jb250ZXh0LnN0YXJ0LmxpbmUsIGNoOiB0aGlzLmNvbnRleHQuc3RhcnQuY2h9KTtcblxuXHRcdGNvbnN0IGZvbGxvd2luZ0NoYXIgPSBlZGl0b3IuZ2V0UmFuZ2Uoe2xpbmU6IHRoaXMuY29udGV4dC5zdGFydC5saW5lLCBjaDogdGhpcy5jb250ZXh0LmVuZC5jaH0sXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0ICB7bGluZTogdGhpcy5jb250ZXh0LnN0YXJ0LmxpbmUsIGNoOiB0aGlzLmNvbnRleHQuZW5kLmNoICsgMX0pO1xuXG5cblx0XHRjb25zdCBzdWdnU3RyID0gJ0AnICsgc3VnZ2VzdGlvbi5pZCA7XG5cblx0XHRsZXQgY3Vyc29yRW5kUG9zID0gbnVsbDtcblxuXHRcdGlmIChmb2xsb3dpbmdDaGFyID09ICddJyl7XG5cdFx0XHRjdXJzb3JFbmRQb3MgPSB0aGlzLmNvbnRleHQuc3RhcnQuY2ggKyBzdWdnU3RyLmxlbmd0aCArIDFcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y3Vyc29yRW5kUG9zID0gdGhpcy5jb250ZXh0LnN0YXJ0LmNoICsgc3VnZ1N0ci5sZW5ndGhcblx0XHR9XG5cblx0XHRlZGl0b3IucmVwbGFjZVJhbmdlKHN1Z2dTdHIsIHRoaXMuY29udGV4dC5zdGFydCwgeydsaW5lJzogdGhpcy5jb250ZXh0LmVuZC5saW5lLCAnY2gnOiB0aGlzLmNvbnRleHQuZW5kLmNoIH0pO1xuXG5cdFx0ZWRpdG9yLnNldEN1cnNvcih7J2xpbmUnOiB0aGlzLmNvbnRleHQuc3RhcnQubGluZSwgJ2NoJzogY3Vyc29yRW5kUG9zfSlcblxuXHRcdHRoaXMuanVzdENvbXBsZXRlZCA9IHRydWU7XG5cblx0fVxuXG59XG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsSUFBQUEsbUJBQTRGOzs7QUNBNUYsc0JBV087QUFZUCxJQUFNLE9BQU8sUUFBUSxNQUFNO0FBRTNCLFNBQVMsZ0JBQWdCLFNBQVMsTUFBTTtBQUNwQyxTQUFPLElBQUksUUFBUSxD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QWdCLE9BQU87QUFBQSxNQUFTLEVBQUMsTUFBTSxLQUFLLFFBQVEsTUFBTSxNQUFNLElBQUksS0FBSyxRQUFRLE1BQU0sS0FBSyxFQUFDO0FBQUEsTUFDeEYsRUFBQyxNQUFNLEtBQUssUUFBUSxNQUFNLE1BQU0sSUFBSSxLQUFLLFFBQVEsTUFBTSxHQUFFO0FBQUEsSUFBQztBQUVyRSxVQUFNLGdCQUFnQixPQUFPO0FBQUEsTUFBUyxFQUFDLE1BQU0sS0FBSyxRQUFRLE1BQU0sTUFBTSxJQUFJLEtBQUssUUFBUSxJQUFJLEdBQUU7QUFBQSxNQUNsRixFQUFDLE1BQU0sS0FBSyxRQUFRLE1BQU0sTUFBTSxJQUFJLEtBQUssUUFBUSxJQUFJLEtBQUssRUFBQztBQUFBLElBQUM7QUFHdkUsVUFBTSxVQUFVLE1BQU0sV0FBVztBQUVqQyxRQUFJLGVBQWU7QUFFbkIsUUFBSSxpQkFBaUIsS0FBSTtBQUN4QixxQkFBZSxLQUFLLFFBQVEsTUFBTSxLQUFLLFFBQVEsU0FBUztBQUFBLElBQ3pELE9BQU87QUFDTixxQkFBZSxLQUFLLFFBQVEsTUFBTSxLQUFLLFFBQVE7QUFBQSxJQUNoRDtBQUVBLFdBQU8sYUFBYSxTQUFTLEtBQUssUUFBUSxPQUFPLEVBQUMsUUFBUSxLQUFLLFFBQVEsSUFBSSxNQUFNLE1BQU0sS0FBSyxRQUFRLElBQUksR0FBRyxDQUFDO0FBRTVHLFdBQU8sVUFBVSxFQUFDLFFBQVEsS0FBSyxRQUFRLE1BQU0sTUFBTSxNQUFNLGFBQVksQ0FBQztBQUV0RSxTQUFLLGdCQUFnQjtBQUFBLEVBRXRCO0FBRUQ7OztBRDVVQSxJQUFNLG1CQUEwQztBQUFBLEVBQy9DLFdBQVc7QUFDWjtBQUVBLElBQXFCLGdCQUFyQixjQUEyQyx3QkFBTztBQUFBLEVBR2pELE1BQU0sU0FBUztBQUNkLFVBQU0sS0FBSyxhQUFhO0FBRXhCLFNBQUssc0JBQXNCLElBQUksZ0JBQWdCLEtBQUssS0FBSyxJQUFJLENBQUM7QUFBQSxFQWlFL0Q7QUFBQSxFQUVBLFdBQVc7QUFBQSxFQUVYO0FBQUEsRUFFQSxNQUFNLGVBQWU7QUFDcEIsU0FBSyxXQUFXLE9BQU8sT0FBTyxDQUFDLEdBQUcsa0JBQWtCLE1BQU0sS0FBSyxTQUFTLENBQUM7QUFBQSxFQUMxRTtBQUFBLEVBRUEsTUFBTSxlQUFlO0FBQ3BCLFVBQU0sS0FBSyxTQUFTLEtBQUssUUFBUTtBQUFBLEVBQ2xDO0FBQ0Q7IiwKICAibmFtZXMiOiBbImltcG9ydF9vYnNpZGlhbiJdCn0K
